---
layout: post
title: 'Deploying/Tuning SparseMap Correctly: Update'
date: 2012-03-01 01:44:26.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags:
- SparseMap
meta:
  _edit_last: '3991311'
  reddit: a:2:{s:5:"count";i:0;s:4:"time";i:1515310661;}
  publicize_results: a:1:{s:7:"twitter";a:1:{i:54083831;a:2:{s:7:"user_id";s:5:"_ieb_";s:7:"post_id";s:18:"175033729364930561";}}}
  _wpas_done_twitter: '1'
  _oembed_76301631fa4d45eec569471aadfb467d: "{{unknown}}"
author:
  login: iebtfdcouk
  email: ieb@tfd.co.uk
  display_name: Ian
  first_name: Ian
  last_name: Boston
permalink: "/2012/03/01/deployingtuning-sparsemap-correctly-update/"
---
<p>In the last post I reported the impact of using SparseMap with caching disabled, but at the same time noticed that there was a error in the way in which JDBC connections where handled. SparseMap doesn't pool JDBC connections. It makes the assumption that anyone using SparseMap will read the Session API and note that Sessions should only be used on one thread during their active life time. Although the SparseMap Session Impl is thread safe, doing that eliminates all blocking synchronization and concurrent locks. If the Session API use followed, then JDBC connections can be taken out of the pool and bound to threads which ensures that only 1 thread will ever access a JDBC connection at any one time. When bound to threads, JDBC sessions can be long lived and so are only revalidated if they have been idle for some time. If any connection is found to be in a error state its replaced with a fresh connection.</p>
<p>In Sakai OAE 1.2, with SparseMap caching inadvertently disabled, and JDBC connections being validated on every request, there were about 500,000 SQL operations in the short load test.  With those issues addressed, the number of SQL operations drops to 6600, <strong>removing almost 1000s (over 15 minutes) from the 1h load test execution time</strong> and removing JDBC entirely from the list of JVM hot spots. Notice that in the last hotspot SparseMap is showing almost no time being blocked by sync operations, although there is more time spent suspended than I would like which needs to be investigated. I cannot stress how important it is to make certain that caching is working properly if you are using SparseMap.  Here are the results, which I cant take any credit for. The Load testing was performed by Jon Cook at Indiana University, full details can be found at <a href="https://uisapp2.iu.edu/confluence-prd/display/ONC/OAE+Evaluation+Load+Test+Results">https://uisapp2.iu.edu/confluence-prd/display/ONC/OAE+Evaluation+Load+Test+Results</a></p>
<p>[caption id="attachment_600" align="alignnone" width="510" caption="SQL Profile Before Caching was enabled correctly."]<a href="http://ianboston.files.wordpress.com/2012/03/screen-shot-2012-03-01-at-12-28-14.png"><img class="size-full wp-image-600" title="SQL Profile Before Caching was enabled correctly." src="{{ site.baseurl }}/assets/screen-shot-2012-03-01-at-12-28-14.png" alt="" width="510" height="172" /></a>[/caption]</p>
<p>[caption id="attachment_601" align="alignnone" width="510" caption="SQL Profile After Caching was enabled correctly"]<a href="http://ianboston.files.wordpress.com/2012/03/screen-shot-2012-03-01-at-12-27-44.png"><img class="size-full wp-image-601" title="SQL Profile After Caching was enabled correctly" src="{{ site.baseurl }}/assets/screen-shot-2012-03-01-at-12-27-44.png" alt="" width="510" height="147" /></a>[/caption]</p>
<p>[caption id="attachment_599" align="alignnone" width="510" caption="JVM Hotspots before Caching was enabled correctly"]<a href="http://ianboston.files.wordpress.com/2012/03/screen-shot-2012-03-01-at-12-28-46.png"><img class="size-full wp-image-599" title="JVM Hotspots before Caching was enabled correctly" src="{{ site.baseurl }}/assets/screen-shot-2012-03-01-at-12-28-46.png" alt="" width="510" height="357" /></a>[/caption]</p>
<p><a href="http://ianboston.files.wordpress.com/2012/03/screen-shot-2012-03-01-at-12-29-00.png"><img class="alignnone size-full wp-image-598" title="JVM Hostspots after Caching was enabled Correctly" src="{{ site.baseurl }}/assets/screen-shot-2012-03-01-at-12-29-00.png" alt="" width="510" height="315" /></a></p>
