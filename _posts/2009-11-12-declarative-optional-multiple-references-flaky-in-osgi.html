---
layout: post
title: Declarative optional multiple references flaky in OSGi
date: 2009-11-12 16:57:56.000000000 +00:00
type: post
parent_id: '0'
published: true
password: ''
status: publish
categories: []
tags: []
meta:
  _edit_last: '3991311'
  delicious: a:3:{s:5:"count";s:1:"0";s:9:"post_tags";s:0:"";s:4:"time";s:10:"1288785604";}
  reddit: a:2:{s:5:"count";s:1:"0";s:4:"time";s:10:"1288785604";}
  _oembed_0c92c539ecc3ba7492b2bf82d3b01ef7: "{{unknown}}"
author:
  login: iebtfdcouk
  email: ieb@tfd.co.uk
  display_name: Ian
  first_name: Ian
  last_name: Boston
permalink: "/2009/11/12/declarative-optional-multiple-references-flaky-in-osgi/"
---
<p>It looks like binding multiple optional references in OSGi is flaky at least with Felix 1.2.0. Uhh what does that mean?</p>
<p>AFAICT, an annotation like</p>
<pre>@Reference(name="virtualResourceType",
 cardinality = ReferenceCardinality.OPTIONAL_MULTIPLE,
 referenceInterface = VirtualResourceType.class)</pre>
<p>with</p>
<pre>public void bindVirtualResourceType(VirtualResourceType virtualResourceType) {
    log.info("Bound "+virtualResourceType);
   store.put(virtualResourceType,virtualResourceType);
}
public void unbindVirtualResourceType(VirtualResourceType virtualResourceType) {
   log.info("UnBound "+virtualResourceType);
   store.remove(virtualResourceType);
}</pre>
<p>Only binds some of the time on reload, but unbind works every time.</p>
<p>I have a feeling that below will work, no idea why ?</p>
<pre>protected void bindVirtualResourceType(ServiceReference reference) {
   VirtualResourceType virtualResourceType =  (VirtualResourceType) this.componentContext.locateService(
       "VirtualResourceType", reference);
   if ( virtualResourceType != null ) {
      LOGGER.info("=====================BOUND VIRTUAL RESOURCE TYPE{}===============================",virtualResourceType.getResourceType());
      virtualResourceTypes.put(virtualResourceType.getResourceType(), virtualResourceType);
   } else {
      LOGGER.info("=====================Faied to find BOUND VIRTUAL RESOURCE TYPE{}===============================",reference);
   }
}
</pre>
<h2>Update:</h2>
<p>The annotation should have been</p>
<p>@Reference(name = "virtualResourceType",<br />
cardinality = ReferenceCardinality.OPTIONAL_MULTIPLE,<br />
referenceInterface = VirtualResourceType.class,<br />
<strong>policy = ReferencePolicy.DYNAMIC</strong>)</p>
<p>and then the bind and unbind can be</p>
<pre>protected void bindVirtualResourceType(VirtualResourceType virtualResourceType) {
    virtualResourceTypes.put(virtualResourceType.getResourceType(), virtualResourceType);
}

protected void unbindVirtualResourceType(VirtualResourceType virtualResourceType) {
    virtualResourceTypes.remove(virtualResourceType.getResourceType());
}

</pre>
<p>(I am an idiot!)</p>
