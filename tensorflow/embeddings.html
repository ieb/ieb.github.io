<html>
<head>
	
</head>
<body>

<ul>
<li> WARNING: This page may crash browsers including Chrome, and in rare cases the OS and GPU. Do not click 
	   "Load Sentences" if you are using an older, unsupported version of Chrome (eg 103 on OSX 10.12 or earlier), 
	   or, if you are feeling brave, save all your work and make sure you have a backup before you do as you may have
	 to hard reboot with a long press on the power button. If you dont believe me.... try it ;) (Issue has been reported to TensorFlow) </li>
<li>Step 1, open Chrome Dev tools so you can see what is happening.</li>
<li>Step 2  <button id="load" >Load Sentences</button></li>
<li>Wait for the tensors to be created, typically 10s, see js console</li>
<li>Step 3: Run searches below, repeat Step 3 as many times as you want</li>
</ul>
	<div> Then query</div>
	<input type="text" name="query" value="Tell me about everything you know" />
	<button id="searchbutton" >Run Search</button>
	<div>
		<textarea name="result"> </textarea>
	</div>

<div>
Debug TF: <input type="checkbox" name="debugtf" value="tfdebug" /> 
</div>
<div>
Based on <a href="https://jinglescode.github.io/textual-similarity-universal-sentence-encoder/">https://jinglescode.github.io/textual-similarity-universal-sentence-encoder/</a>
</div>

 <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/universal-sentence-encoder"></script>
	<script type="text/javascript">
		
function dotp(x, y) {
  function dotp_sum(a, b) {
    return a + b;
  }
  function dotp_times(a, i) {
    return x[i] * y[i];
  }
  return x.map(dotp_times).reduce(dotp_sum, 0);
}

function cosineSimilarity(A,B){
  var similarity = dotp(A, B) / (Math.sqrt(dotp(A,A)) * Math.sqrt(dotp(B,B)));
  return similarity;
}

function createTensor(range, length) {
	const tensor = [];
	for (let j = 0; j < length; j++) {
		tensor.push((Math.random()-0.5)*range);
	}
	return tensor;	
}

var dataset = [];
var pageIndex = undefined;
var model = undefined;

async function measureTimeAsync(m,f) {
	console.log("Start ",m);
	const start = new Date();
	const ret = await f();
	const end = new Date();
	console.log("End ",m, end.getTime() - start.getTime(), "ms");
	return ret;

}

async function get_embeddings(list_sentences, callback) {
	if ( model === undefined ) {
		model = await measureTimeAsync("Loading Model", async () => { return await use.load(); });
	}
	embeddings = await measureTimeAsync("Get embeddings", async () => {
		return await model.embed(list_sentences);
	});
	return embeddings;
}

async function search(query) {
	if ( dataset === undefined ) {
		document.querySelector('[name="result"]').value = "No model loaded: Did you press Load Sentences ?";
		return;
	}
	console.log("Start Query");
	const start = new Date();
	const searchEmbedding = await get_embeddings([query]);
	const searchTensor = searchEmbedding.arraySync()[0];
	console.log(searchTensor);
	let nmatches = 0;
	const result = [];
	await measureTimeAsync("cosine ", async () => {
		for (var i = dataset.length - 1; i >= 0; i--) {
			const score = cosineSimilarity(searchTensor, dataset[i]);
			if (  score > 0.2) {
					nmatches++;
					result.push({ score, page: pageIndex.data[i].path })
					console.log("Matches", pageIndex.data[i]);
			}
		}
		result.sort((a,b) => {
			return b.score - a.score;
		});
	});
	console.log("Matches", nmatches);
	const end = new Date();
	console.log("Took ",end.getTime()-start.getTime(),"ms");
	document.querySelector('[name="result"]').value = JSON.stringify(result,null,2);
	
}
async function loadSentences() {

	const start = new Date();
	console.log("Start Create Index");
  if ( pageIndex === undefined) {
	  const result = await fetch("testindexdata.json");
	  pageIndex = await result.json();  	
  } 
	console.log(pageIndex.data);
	let l = [];
	for (let i = 0; i < pageIndex.data.length; i++ ) {
		l.push(pageIndex.data[i].content);
		if ( l.length > 9)  {
			const embeddings = await get_embeddings(l);
			embeddings.arraySync().forEach((e) => {
				dataset.push(e);
			});	
			console.log("Added 10 total ",dataset.length);
			l = [];
		}
	}
	if ( l.length > 0) {
			const embeddings = await get_embeddings(l);
			embeddings.arraySync().forEach((e) => {
				dataset.push(e);
			});	
			l = [];
	}
	console.log("Dataset Now", dataset);
	const end = new Date();
	console.log("Took ",end.getTime()-start.getTime(),"ms");

}
document.querySelector("#searchbutton").addEventListener("click", async (e) => {
	await search(document.querySelector('[name="query"]').value);
});
document.querySelector("#load").addEventListener("click", async (e) => {
	await loadSentences();
});
document.querySelector('[name="debugtf"]').addEventListener("change", async (e) => {
	if ( document.querySelector('[name="debugtf"]').checked ) {
		tf.enableDebugMode();
	} else {
		console.log("Disabling debug, using prod mode");
		tf.enableProdMode();
	}
});




	</script>
</body>
</html>
